---
import { CONTACT } from "../../constants/contact";

const ENABLED = import.meta.env.PUBLIC_PLAUSIBLE_ENABLED === "true";
const DOMAIN = import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN || "thekpsgroup.com";
---

{ENABLED && (
  <Fragment>
    <script
      defer
      data-domain={DOMAIN}
      src="https://plausible.io/js/script.js"
    ></script>
    <script>
      // helper to safely call plausible
      window.plausibleTrack = function (name, props = {}) {
        try {
          if (typeof window.plausible === "function") {
            window.plausible(name, { props });
          }
        } catch {}
      };

      // Track CTA clicks
      const PHONE_HREF = "${CONTACT.phoneHref}";
      document.addEventListener("click", (e) => {
        const tel = e.target.closest?.("a[href^='tel:']");
        if (tel && tel.getAttribute("href") === PHONE_HREF) {
          const props = {
            text: (tel.innerText || "").trim(),
            href: PHONE_HREF,
            location: window.location.pathname,
          };
          window.plausibleTrack("cta_phone_click", props);
        }

        const cta = e.target.closest?.("[data-cta]");
        const mail = e.target.closest?.("a[href^='mailto:']");
        const target = cta || mail;
        if (!target) return;
        const props = {
          id: target.id || "",
          text: (target.innerText || "").trim(),
          href: target.getAttribute("href") || "",
          location: window.location.pathname,
        };
        window.plausibleTrack("cta_click", props);
      });

      // Track form events via CustomEvents
      document.addEventListener("form_submit_click", (e) => {
        const d = (e && e.detail) || {};
        window.plausibleTrack("form_submit_click", {
          location: window.location.pathname,
          ...d,
        });
      });

      document.addEventListener("form_submit_success", (e) => {
        const d = (e && e.detail) || {};
        window.plausibleTrack("form_submit_success", {
          location: window.location.pathname,
          ...d,
        });
      });

      document.addEventListener("form_submit_error", (e) => {
        const d = (e && e.detail) || {};
        window.plausibleTrack("form_submit_error", {
          location: window.location.pathname,
          ...d,
        });
      });

      document.addEventListener("form_submit_invalid", (e) => {
        const d = (e && e.detail) || {};
        window.plausibleTrack("form_submit_invalid", {
          location: window.location.pathname,
          ...d,
        });
      });
    </script>
  </Fragment>
)}
