---
const ENABLED = import.meta.env.PUBLIC_PLAUSIBLE_ENABLED === "true";
const DOMAIN = import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN || "thekpsgroup.com";
---

{ENABLED && (
  <Fragment>
    <script
      defer
      data-domain={DOMAIN}
      src="https://plausible.io/js/script.js"
    ></script>
    <script>
      // helper to safely call plausible
      window.plausibleTrack = function (name, props = {}) {
        try {
          if (typeof window.plausible === "function") {
            window.plausible(name, { props });
          }
        } catch {}
      };

      // Track CTA clicks on [data-track="cta"]
      document.addEventListener("click", (e) => {
        const t = e.target.closest?.("[data-track='cta']");
        if (!t) return;
        const props = {
          id: t.id || "",
          text: (t.innerText || "").trim(),
          href: t.getAttribute("href") || "",
          location: window.location.pathname,
        };
        window.plausibleTrack("cta_click", props);
      });

      // Track form events via CustomEvents:
      //  document.dispatchEvent(new CustomEvent("form:submit:success", { detail: {...} }))
      //  document.dispatchEvent(new CustomEvent("form:submit:error", { detail: {...} }))
      document.addEventListener("form:submit:success", (e) => {
        const d = (e && e.detail) || {};
        window.plausibleTrack("form_submit_success", {
          location: window.location.pathname,
          ...d,
        });
      });

      document.addEventListener("form:submit:error", (e) => {
        const d = (e && e.detail) || {};
        window.plausibleTrack("form_submit_error", {
          location: window.location.pathname,
          ...d,
        });
      });
    </script>
  </Fragment>
)}
